---
title: Android 消息机制
date: 2016-04-18 12:07:34
tags: Android
categories: Android

---

{% asset_img handler.jpg This is an example image %}

如图可知Android的消息分法机制

在Android中的每个线程都会绑定一个Looper。这个Looper是封装自ThreadLocal，即是线程的本地局部变量。Android的主线程（UI线程）启动时会自行绑定一个Looper，而这个Looper里面又会绑定一个消息队列，Looper将会循环读取这个消息队列里的消息进行执行。

Handler创建时候要绑定一个消息队列，这个消息队列当然必须从Looper里取，而又因为Looper封装在ThreadLocal当中的，所以相当于Handler也和当前线程绑定了，因为必须取得当前线程的Looper，才能取得它的消息队列。Handler的任务就是两个，一是将消息post到消息队列里，二是从消息队列里取出来然后按照指定的方法去处理消息，根据上图就形成了一个循环。

所以就不难理解，当我们新建一个线程的时候，为什么直接创建Handler会失败了，因为新建线程没有创建Looper，所以无法从新线程的ThreadLocal里取得。所以要Looper.prepare()以及Looper.loop(),来启动这个消息循环。
